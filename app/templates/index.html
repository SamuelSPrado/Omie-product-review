<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Omie Product Review</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<h1>Análise de Produtos Integrados</h1>

<form method="post">
    <label>Selecione o local:</label>
    <select name="local" required>
        <option value="">-- Selecione --</option>
        {% for l in locais %}
            <option value="{{ l }}" {% if l == local_selecionado %}selected{% endif %}>
                {{ l }}
            </option>
        {% endfor %}
    </select>

    <button type="submit">Buscar</button>
</form>

{% if produtos %}

<!-- Filtro por Status -->
<div style="margin-bottom: 12px;">
    <label for="filtro-status"><strong>Filtrar por status:</strong></label>
    <select id="filtro-status">
        <option value="">Todos</option>
        <option value="Sem código integração">Sem código integração</option>
        <option value="Código divergênte">Código divergênte</option>
        <option value="Códigos corretos">Códigos corretos</option>
        <option value="Sucesso">Sucesso</option>
        <option value="Erro">Erro</option>
    </select>
</div>

<table>
    <thead>
        <tr>
            <th>Código Produto</th>
            <th>Descrição</th>
            <th>Código</th>
            <th>Código Integração</th>
            <th>Ação</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for p in produtos %}
        <tr>
            <td>{{ p.codigo_produto }}</td>
            <td>{{ p.descricao }}</td>
            <td>{{ p.codigo }}</td>

            <td>
                <input type="text"
                       class="codigo-integracao"
                       value="{{ p.codigo_produto_integracao }}">
            </td>

            <td>
                <button type="button"
                        class="btn-associar"
                        data-local="{{ local_selecionado }}"
                        data-codigo-produto="{{ p.codigo_produto }}">
                    Associar
                </button>
            </td>

            <td class="status
                {% if p.status == 'Códigos corretos' %}ok
                {% elif p.status == 'Sem código integração' %}warn
                {% else %}error{% endif %}">
                {{ p.status }}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<script>
// Associação via fetch (sem reload)
document.querySelectorAll(".btn-associar").forEach(btn => {
    btn.addEventListener("click", async function () {
        const row = btn.closest("tr");
        const statusCell = row.querySelector(".status");
        const input = row.querySelector(".codigo-integracao");

        const payload = {
            local: btn.dataset.local,
            codigo_produto: btn.dataset.codigoProduto,
            codigo_integracao: input.value
        };

        try {
            const response = await fetch("/associar-json", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            alert(JSON.stringify(data, null, 2));

            if (data.codigo_status === "0") {
                statusCell.innerText = "Sucesso";
                statusCell.className = "status ok";
            } else {
                statusCell.innerText = "Erro";
                statusCell.className = "status error";
            }

        } catch (err) {
            alert("Erro de comunicação com o servidor");
            statusCell.innerText = "Erro";
            statusCell.className = "status error";
        }
    });
});

// Filtro por status (client-side)
const filtroStatus = document.getElementById("filtro-status");

if (filtroStatus) {
    filtroStatus.addEventListener("change", function () {
        const statusSelecionado = this.value;

        document.querySelectorAll("tbody tr").forEach(row => {
            const statusCell = row.querySelector(".status");
            const statusTexto = statusCell.innerText.trim();

            if (!statusSelecionado || statusTexto === statusSelecionado) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    });
}
</script>

</body>
</html>