<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Omie Product Review</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<h1>Análise de Produtos Integrados</h1>

<form method="post">
    <label>Selecione o local:</label>
    <select name="local" required>
        <option value="">-- Selecione --</option>
        {% for l in locais %}
            <option value="{{ l }}" {% if l == local_selecionado %}selected{% endif %}>
                {{ l }}
            </option>
        {% endfor %}
    </select>

    <button type="submit">Buscar</button>
</form>

{% if produtos %}
<table>
    <thead>
        <tr>
            <th>Código Produto</th>
            <th>Descrição</th>
            <th>Código</th>
            <th>Código Integração</th>
            <th>Ação</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for p in produtos %}
        <tr>
            <td>{{ p.codigo_produto }}</td>
            <td>{{ p.descricao }}</td>
            <td>{{ p.codigo }}</td>

            <td>
                <input type="text"
                       class="codigo-integracao"
                       data-codigo-produto="{{ p.codigo_produto }}"
                       value="{{ p.codigo_produto_integracao }}">
            </td>

            <td>
                <button type="button"
                        data-local="{{ local_selecionado }}"
                        onclick="associarCodigo(this)">
                    Associar
                </button>
            </td>

            <td class="status">
                {{ p.status }}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<script>
async function associarCodigo(botao) {
    const linha = botao.closest("tr");
    const input = linha.querySelector(".codigo-integracao");
    const statusCell = linha.querySelector(".status");

    const payload = {
        local: botao.dataset.local,
        codigo_produto: input.dataset.codigoProduto,
        codigo_integracao: input.value
    };

    statusCell.textContent = "Processando...";

    try {
        const response = await fetch("/associar-json", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!response.ok) {
            statusCell.textContent = data.erro || "Erro";
            return;
        }

        statusCell.textContent = data.status;
    } catch (e) {
        statusCell.textContent = "Erro de comunicação";
    }
}
</script>

</body>
</html>